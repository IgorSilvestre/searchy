<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Searchy – Minimal Client</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      label { display:block; margin-top: 1rem; font-weight: 600; }
      input { width: 100%; max-width: 900px; padding: 0.5rem; font: inherit; }
      button { margin-top: 1rem; padding: 0.45rem 0.8rem; font: inherit; cursor: pointer; }
      .muted { color: #6b7280; }
      .meta { margin-top: 1rem; font-size: 14px; }
      .meta code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
      table { border-collapse: collapse; margin-top: 1rem; max-width: 95vw; }
      th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; vertical-align: top; font-size: 14px; }
      thead { background: #f3f4f6; }
      header { display:flex; gap: 12px; align-items: center; justify-content: space-between; max-width: 900px; }
      /* Tabs */
      .tabs { display: flex; gap: 8px; margin-top: 1rem; }
      .tab-btn { border: 1px solid #d1d5db; background: #f9fafb; padding: 6px 10px; border-radius: 6px; }
      .tab-btn.active { background: #111827; color: white; border-color: #111827; }
      .tab { display: none; max-width: 900px; }
      .tab.active { display: block; }
      /* Chat */
      .chat { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; background: #fafafa; max-width: 900px; margin-top: 8px; }
      .msg { margin: 6px 0; padding: 8px 10px; border-radius: 8px; white-space: pre-wrap; }
      .msg.user { background: #e0f2fe; }
      .msg.assistant { background: #ecfdf5; }
      .row { display: flex; gap: 8px; align-items: center; }
      .row input { flex: 1; }
    </style>
  </head>
  <body>
    <header>
      <h1 style="margin: 0;">Searchy</h1>
      <button id="langBtn" type="button">Português</button>
    </header>
    <p id="intro">Enter a phrase and a Postgres connection URL. The result table appears below.</p>

    <div class="tabs">
      <button id="tabQueryBtn" class="tab-btn active" type="button">Query</button>
      <button id="tabExplainBtn" class="tab-btn" type="button">Explain</button>
    </div>

    <section id="queryTab" class="tab active">
      <form id="qform">
        <label for="phrase" id="phraseLabel">Phrase</label>
        <input id="phrase" name="phrase" placeholder="e.g. last 10 paid orders with emails" required />

        <label for="dbUrl" id="dbUrlLabel">dbUrl</label>
        <input id="dbUrl" name="dbUrl" placeholder="postgres://user:pass@host:5432/db" />

        <button id="runBtn" type="submit">Run</button>
      </form>

      <h2 id="resultHeader">Result</h2>
      <div id="out" class="muted">(no response yet)</div>
    </section>

    <section id="explainTab" class="tab">
      <div class="meta" style="margin-bottom:8px;">Ask questions about your schema/relations. Previous Q&amp;A is sent as context.</div>
      <label for="dbUrl2" id="dbUrl2Label">dbUrl</label>
      <input id="dbUrl2" name="dbUrl2" placeholder="postgres://user:pass@host:5432/db" />

      <div id="chat" class="chat" aria-live="polite"></div>
      <form id="eform" class="row">
        <input id="eq" name="eq" placeholder="e.g. how do orders link to customers?" />
        <button id="askBtn" type="submit">Ask</button>
        <button id="clearBtn" type="button">Clear chat</button>
      </form>
    </section>

    <script>
      const form = document.getElementById('qform');
      const out = document.getElementById('out');
      const langBtn = document.getElementById('langBtn');
      const runBtn = document.getElementById('runBtn');
      const phraseInput = document.getElementById('phrase');
      const dbUrlInput = document.getElementById('dbUrl');
      const phraseLabel = document.getElementById('phraseLabel');
      const dbUrlLabel = document.getElementById('dbUrlLabel');
      const dbUrl2Input = document.getElementById('dbUrl2');
      const dbUrl2Label = document.getElementById('dbUrl2Label');
      const resultHeader = document.getElementById('resultHeader');
      const intro = document.getElementById('intro');
      const tabQueryBtn = document.getElementById('tabQueryBtn');
      const tabExplainBtn = document.getElementById('tabExplainBtn');
      const queryTab = document.getElementById('queryTab');
      const explainTab = document.getElementById('explainTab');
      const chatEl = document.getElementById('chat');
      const eform = document.getElementById('eform');
      const eqInput = document.getElementById('eq');
      const clearBtn = document.getElementById('clearBtn');

      const i18n = {
        en: {
          title: 'Searchy – Minimal Client',
          intro: 'Enter a phrase and a Postgres connection URL. The result table appears below.',
          phraseLabel: 'Phrase',
          phrasePh: 'e.g. last 10 paid orders with emails',
          dbUrlLabel: 'dbUrl',
          dbUrlPh: 'postgres://user:pass@host:5432/db',
          dbUrl2Label: 'dbUrl',
          ask: 'Ask',
          clearChat: 'Clear chat',
          explainTab: 'Explain',
          queryTab: 'Query',
          askPh: 'e.g. how do orders link to customers?',
          run: 'Run',
          resultHeader: 'Result',
          noResp: '(no response yet)',
          loading: 'Loading...',
          unexpected: 'Unexpected server response.',
          noRows: 'No results.',
          errPrefix: 'Error: ',
          parseErr: 'Failed to parse response.',
          rowsLabel: 'Rows:',
          sqlLabel: 'SQL:',
          langToggle: 'Português'
        },
        pt: {
          title: 'Searchy – Cliente Minimal',
          intro: 'Informe uma frase e a URL de conexão do Postgres. A tabela de resultados aparece abaixo.',
          phraseLabel: 'Frase',
          phrasePh: 'ex.: últimos 10 pedidos pagos com e-mails',
          dbUrlLabel: 'dbUrl',
          dbUrlPh: 'postgres://usuario:senha@host:5432/banco',
          dbUrl2Label: 'dbUrl',
          ask: 'Perguntar',
          clearChat: 'Limpar conversa',
          explainTab: 'Explicar',
          queryTab: 'Consulta',
          askPh: 'ex.: como pedidos se ligam a clientes?',
          run: 'Executar',
          resultHeader: 'Resultado',
          noResp: '(ainda sem resposta)',
          loading: 'Carregando...',
          unexpected: 'Resposta inesperada do servidor.',
          noRows: 'Sem resultados.',
          errPrefix: 'Erro: ',
          parseErr: 'Erro ao interpretar a resposta.',
          rowsLabel: 'Linhas:',
          sqlLabel: 'SQL:',
          langToggle: 'English'
        }
      };

      let lang = 'en';

      function applyLang() {
        const t = i18n[lang];
        document.title = t.title;
        intro.textContent = t.intro;
        phraseLabel.textContent = t.phraseLabel;
        phraseInput.placeholder = t.phrasePh;
        dbUrlLabel.textContent = t.dbUrlLabel;
        dbUrlInput.placeholder = t.dbUrlPh;
        dbUrl2Label.textContent = t.dbUrl2Label;
        dbUrl2Input.placeholder = t.dbUrlPh;
        runBtn.textContent = t.run;
        resultHeader.textContent = t.resultHeader;
        langBtn.textContent = t.langToggle;
        tabQueryBtn.textContent = t.queryTab;
        tabExplainBtn.textContent = t.explainTab;
        eqInput.placeholder = t.askPh;
        document.getElementById('askBtn').textContent = t.ask;
        clearBtn.textContent = t.clearChat;
        if (out.classList.contains('muted')) {
          out.textContent = t.noResp;
        }
      }

      langBtn.addEventListener('click', () => {
        lang = lang === 'en' ? 'pt' : 'en';
        applyLang();
      });

      applyLang();

      const escape = (s) => String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      function renderResult(rows, sql, rowCount) {
        const t = i18n[lang];
        if (!Array.isArray(rows)) {
          out.textContent = t.unexpected;
          return;
        }
        if (rows.length === 0) {
          const meta = `<div class="meta"><strong>${t.rowsLabel}</strong> 0</div>` +
                       (sql ? `<div class="meta"><strong>${t.sqlLabel}</strong> <code>${escape(sql)}</code></div>` : '');
          out.innerHTML = meta + `<div class="muted">${t.noRows}</div>`;
          return;
        }
        // Collect columns from union of keys
        const cols = Array.from(rows.reduce((set, r) => {
          Object.keys(r || {}).forEach(k => set.add(k));
          return set;
        }, new Set())).sort();

        const meta = `<div class="meta"><strong>${t.rowsLabel}</strong> ${rowCount ?? rows.length}</div>` +
                     (sql ? `<div class="meta"><strong>${t.sqlLabel}</strong> <code>${escape(sql)}</code></div>` : '');
        let html = meta + '<table><thead><tr>' + cols.map(c => `<th>${escape(c)}</th>`).join('') + '</tr></thead><tbody>';
        for (const r of rows) {
          html += '<tr>' + cols.map(c => {
            let v = r?.[c];
            if (v === null || v === undefined) v = '';
            else if (typeof v === 'object') v = JSON.stringify(v);
            return `<td>${escape(v)}</td>`;
          }).join('') + '</tr>';
        }
        html += '</tbody></table>';
        out.innerHTML = html;
        out.classList.remove('muted');
      }

      // Tabs
      function setActiveTab(which) {
        if (which === 'query') {
          queryTab.classList.add('active');
          explainTab.classList.remove('active');
          tabQueryBtn.classList.add('active');
          tabExplainBtn.classList.remove('active');
        } else {
          queryTab.classList.remove('active');
          explainTab.classList.add('active');
          tabQueryBtn.classList.remove('active');
          tabExplainBtn.classList.add('active');
        }
      }
      tabQueryBtn.addEventListener('click', () => setActiveTab('query'));
      tabExplainBtn.addEventListener('click', () => { setActiveTab('explain'); loadChat(); });

      // Explain chat
      const STORAGE_KEY = 'searchy_explain_chat_v1';
      let chatHistory = [];
      function appendMsg(role, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + role;
        div.textContent = text;
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
      }
      function renderChatFromHistory() {
        chatEl.innerHTML = '';
        for (const m of chatHistory) appendMsg(m.role, m.content);
      }
      function saveChat() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory)); } catch {}
      }
      function loadChat() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          chatHistory = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(chatHistory)) chatHistory = [];
        } catch { chatHistory = []; }
        renderChatFromHistory();
      }
      function buildContext() {
        let ctx = '';
        for (const t of chatHistory) {
          if (t.role === 'user') ctx += `Q: ${t.content}\n`;
          else if (t.role === 'assistant') ctx += `A: ${t.content}\n`;
        }
        return ctx.trim();
      }
      eform.addEventListener('submit', async (e) => {
        e.preventDefault();
        const q = eqInput.value.trim();
        if (!q) return;
        const dbUrl = (dbUrl2Input.value || dbUrlInput.value || '').trim() || undefined;
        chatHistory.push({ role: 'user', content: q });
        appendMsg('user', q);
        saveChat();
        eqInput.value = '';
        const thinking = document.createElement('div');
        thinking.className = 'msg assistant muted';
        thinking.textContent = i18n[lang].loading;
        chatEl.appendChild(thinking);
        try {
          const context = buildContext();
          const res = await fetch('/explain', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phrase: q, dbUrl, context })
          });
          const data = await res.json().catch(() => null);
          chatEl.removeChild(thinking);
          if (!res.ok || !data || typeof data.answer !== 'string') {
            const msg = data && data.error ? data.error : (i18n[lang].unexpected);
            chatHistory.push({ role: 'assistant', content: msg });
            appendMsg('assistant', msg);
            return;
          }
          chatHistory.push({ role: 'assistant', content: data.answer });
          appendMsg('assistant', data.answer);
          saveChat();
        } catch (err) {
          chatEl.removeChild(thinking);
          const msg = i18n[lang].errPrefix + (err && err.message ? err.message : String(err));
          chatHistory.push({ role: 'assistant', content: msg });
          appendMsg('assistant', msg);
          saveChat();
        }
      });

      // Load chat initially
      loadChat();

      // Clear chat
      clearBtn.addEventListener('click', () => {
        chatHistory = [];
        try { localStorage.removeItem(STORAGE_KEY); } catch {}
        renderChatFromHistory();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const t = i18n[lang];
        out.textContent = t.loading;
        out.classList.add('muted');
        const phrase = document.getElementById('phrase').value;
        const dbUrl = document.getElementById('dbUrl').value || undefined;
        try {
          const res = await fetch('/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phrase, dbUrl })
          });
          const text = await res.text();
          let parsed;
          try { parsed = JSON.parse(text); } catch (e) {
            out.textContent = t.parseErr;
            return;
          }
          if (!res.ok) {
            const msg = parsed && parsed.error ? parsed.error : 'Request error';
            out.textContent = t.errPrefix + msg;
            return;
          }
          if (parsed && Array.isArray(parsed.rows)) {
            renderResult(parsed.rows, parsed.sql, parsed.rowCount);
          } else {
            out.textContent = t.noRows;
          }
        } catch (err) {
          out.textContent = i18n[lang].errPrefix + (err && err.message ? err.message : String(err));
        }
      });
    </script>
  </body>
  </html>
